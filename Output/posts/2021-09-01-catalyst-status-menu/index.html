<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="overdesigned blog"/><link rel="canonical" href="https://blog.overdesigned.net/posts/2021-09-01-catalyst-status-menu"/><meta name="twitter:url" content="https://blog.overdesigned.net/posts/2021-09-01-catalyst-status-menu"/><meta name="og:url" content="https://blog.overdesigned.net/posts/2021-09-01-catalyst-status-menu"/><title>Standalone Status Menu in a Mac Catalyst App | overdesigned blog</title><meta name="twitter:title" content="Standalone Status Menu in a Mac Catalyst App | overdesigned blog"/><meta name="og:title" content="Standalone Status Menu in a Mac Catalyst App | overdesigned blog"/><meta name="description" content="How to create a standalone “status menu” app and embed it in your Mac Catalyst app."/><meta name="twitter:description" content="How to create a standalone “status menu” app and embed it in your Mac Catalyst app."/><meta name="og:description" content="How to create a standalone “status menu” app and embed it in your Mac Catalyst app."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to overdesigned blog"/></head><body class="item-page"><header><div class="wrapper"><a href="/"><b>over</b>designed blog</a><p class="secondary">by Adam Overholtzer</p></div></header><div class="wrapper"><article><div class="content"><h1>Standalone Status Menu in a Mac Catalyst App</h1><figure><img src="/images/cheatsheet-menu.jpg" srcset="/images/cheatsheet-menu.jpg 2x" alt="Screenshot of Cheatsheet’s status menu" /></figure><p>I make a somewhat successful app called <a href="https://itunes.apple.com/app/id1468213484">Cheatsheet</a>, which is available for iOS, watchOS, and — thanks to Catalyst — macOS. Cheatsheet makes it easy to get to your notes from anywhere, which means widgets and custom keyboards on iOS and complications on watchOS. On macOS, Cheatsheet has a <em>status menu app</em>.</p><p>Look up at the righthand side of a Mac’s menu bar and you’ll see a row of icons called <strong>status menus</strong>. Several status menus are provided by macOS, such as the Wi-Fi and Volume controls. Third-party apps can also create status menus to provide easy, always-available access to app features.</p><p>In this post, I will walk you through creating a <strong>status menu app</strong> — a small Mac app that runs separately from its parent app — and embedding it in a Mac Catalyst app. The parent app will have a checkbox that shows or hides the status menu, and clicking the status menu icon will show a popover.</p><figure><img src="/images/status-menu-example.jpg" alt="Screenshot of my sample app and status menu" /></figure><h2>Create the Status Menu App</h2><p>Let’s start with the fun part: building the status menu app. We’ll build this new app with AppKit and SwiftUI, not iOS or Catalyst. Don’t fret if you’re new to AppKit — I’ll give you what you need, and then you can build the rest of your interface with SwiftUI.</p><p>To begin, select your project and add a new <strong>Mac App</strong> target.</p><figure><img src="/images/menu-mac-app.png" srcset="/images/menu-mac-app.png 2x" alt="Screenshot of a Xcode’s Add Target window" /></figure><p>Then in the “Choose options for your new target” screen, select <strong>Interface: SwiftUI</strong> and <strong>Life Cycle: AppKit App Delegate</strong>. We need the AppDelegate so we can create a windowless app, which is <em>technically</em> possible with the SwiftUI life cycle but it’s a bit of a <a href="https://github.com/zaferarican/menubarpopoverswiftui2">hack</a> and still requires an app delegate.</p><figure><img src="/images/menu-life-cycle.png" srcset="/images/menu-life-cycle.png 2x" alt="Screenshot of a Xcode’s Choose options for your new target window" /></figure><p>Enter a <strong>Product Name</strong> and click <strong>Finish</strong>.</p><p>Now select your new target and switch to its <strong>Info</strong> tab. Add a new property: <strong>Application is agent (UIElement)</strong>. Set its value to <strong>YES</strong>. This cryptically-named property tells macOS to run your app as an “agent”, which means it won’t appear in the Dock or the Force Quit window.</p><figure><img src="/images/menu-uielement.png" srcset="/images/menu-uielement.png 2x" alt="Screenshot of the Info tab of our new target in Xcode" /></figure><p>With that out of the way, we’re ready to code! In the project navigator, open your new target’s <strong>AppDelegate.swift</strong> and look for <code>applicationDidFinishLaunching</code>. It will contain a bunch of code creating a window — delete all of that and replace it with this:</p><pre data-language="swift"><code><span class="hljs-comment">// AppDelegate.swift</span>

<span class="hljs-meta">@NSApplicationMain</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppDelegate</span>: <span class="hljs-title">NSObject</span>, <span class="hljs-title">NSApplicationDelegate</span> </span>{
    
    <span class="hljs-keyword">var</span> statusItem : <span class="hljs-type">NSStatusItem!</span>
    <span class="hljs-keyword">var</span> popover : <span class="hljs-type">NSPopover!</span>

    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">applicationDidFinishLaunching</span><span class="hljs-params">(<span class="hljs-number">_</span> aNotification: Notification)</span></span> {

        <span class="hljs-comment">// Create the status item</span>
        statusItem = <span class="hljs-type">NSStatusBar</span>.system.statusItem(withLength: <span class="hljs-type">NSStatusItem</span>.variableLength)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> statusButton = statusItem?.button {
            statusButton.image = <span class="hljs-type">NSImage</span>(systemSymbolName: <span class="hljs-string">"tornado"</span>, accessibilityDescription: <span class="hljs-literal">nil</span>)
            statusButton.action = #selector(togglePopover(sender:))
            statusButton.target = <span class="hljs-keyword">self</span>
        }
        
        <span class="hljs-comment">// Create the popover</span>
        popover = <span class="hljs-type">NSPopover</span>()
        <span class="hljs-keyword">let</span> content = <span class="hljs-type">NSHostingController</span>(rootView: <span class="hljs-type">ContentView</span>())
        popover.contentViewController = content
        popover.contentSize = content.view.intrinsicContentSize
        popover.behavior = .transient
        popover.animates = <span class="hljs-literal">false</span>
    }
}
</code></pre><p>This code does two things:</p><ol><li>Creates a new <code>NSStatusItem</code> in the system status bar. Status items can have either a drop-down menu or a button; we’ll create a button with a tornado icon that displays a popover when clicked.</li><li>Creates an <code>NSPopover</code> with a SwiftUI view. We set the popover’s <code>behavior</code> to <code>.transient</code>, which means the popover closes if you click anywhere outside of it, and <code>animates</code> to <em>false</em> because I find the default open/close animations to be frustratingly slow. We also set the popover’s <code>contentSize</code> here using the SwiftUI view’s <code>intrinsicContentSize</code> — ideally, SwiftUI would size the popover for us, but in my testing it seems we need to set the <code>contentSize</code> before we try to show the popover.</li></ol><p>Now all we need is to add <code>togglePopover(sender:)</code> to <strong>AppDelegate.swift</strong>:</p><pre data-language="swift"><code><span class="hljs-comment">// AppDelegate.swift</span>

<span class="hljs-meta">@objc</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">togglePopover</span><span class="hljs-params">(sender: <span class="hljs-keyword">Any</span>?)</span></span> {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> statusButton = statusItem.button <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
    
    <span class="hljs-keyword">if</span> popover.isShown {
        popover.performClose(sender)
    } <span class="hljs-keyword">else</span> {
        popover.show(relativeTo: statusButton.bounds,
                     of: statusButton,
                     preferredEdge: <span class="hljs-type">NSRectEdge</span>.maxY)
    }
}
</code></pre><p>This shows the popover relative to the status item, or closes the popover if it’s already showing.</p><p>At this point, you should be able to <strong>Run</strong> your status menu target. The little tornado icon should appear in the menu bar, and clicking it should show a popover.</p><h2>Add to Catalyst Project</h2><p>Now let’s switch back to our main target, which is our Mac Catalyst app. How do we embed our little status menu app into our main app?</p><ol><li>Add menu’s product to dependencies</li><li>add “copy” build stage</li></ol><h2>Add Controls</h2><ol><li>Define SMLoginItemSetEnabled in bridging header</li><li>Create StatusMenuHelper</li><li>Wire-up UI</li></ol><p>And we’re done!</p><blockquote class="twitter-tweet" data-dnt="true"><p lang="en" dir="ltr">that’s a good question for <a href="https://twitter.com/aoverholtzer?ref_src=twsrc%5Etfw">@aoverholtzer</a>, who’s done exactly that in <a href="https://twitter.com/cheatsheet_app?ref_src=twsrc%5Etfw">@cheatsheet_app</a></p>&mdash; Steve Troughton-Smith (@stroughtonsmith) <a href="https://twitter.com/stroughtonsmith/status/1429970709791522817?ref_src=twsrc%5Etfw">August 24, 2021</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h2>What is a Status Menu?</h2><figure><img src="/images/status-menu-help.png" srcset="/images/status-menu-help.png 2x" alt="Screenshot of a status menu, courtesy of https://support.apple.com/guide/mac-help/menu-bar-mchlp1446/mac" /></figure><p>Embedding a status menu app in a Catalyst app is a bit of a trick, and <a href="https://twitter.com/stroughtonsmith/status/1429970709791522817?ref_src=twsrc%5Etfw">apparently</a> folks want to know how I did it. Here’s how!</p></div><p class="secondary">Posted by Adam Overholtzer on September 1, 2021</p></article></div><footer><p>&copy; 2020 <a href="https://overdesigned.net">C. Adam Overholtzer</a> &bull; <a href="/feed.rss">RSS</a> &bull; <a href="https://twitter.com/aoverholtzer">Contact</a></p></footer></body></html>